---
title: "Fase 4.2: Espressione di *Tbx1*)"
author: "Giacomo Pensiero"
date: "2025-10-13"
output: html_document
---
In questo script viene eseguita una parte della Fase 4 dell’analisi, dedicata alla valutazione dell’espressione di *Tbx1* nei cluster (risoluzione *0.10*). Viene caricato l’oggetto ottenuto dalle fasi precedenti *bone_multi*.

L’espressione di *Tbx1* viene visualizzata per cluster (VlnPlot) e sulla proiezione *UMAP* (FeaturePlot), e viene riassunta calcolando l’espressione media e la percentuale di nuclei *Tbx1* positivi per cluster. Infine, l’espressione di *Tbx1* viene confrontata tra condizioni sperimentali (*WT* vs *MUT*) mediante visualizzazioni separate per genotipo.

```{r libreria, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
library(Seurat)
library(ggplot2)
library(patchwork)
library(dplyr)
set.seed(1234)
```

```{r path, echo=TRUE, eval=TRUE, message=FALSE, warning=TRUE}
base_path <- "C:/Users/giaco/OneDrive/Desktop/TBX1/Analisi_Giacomo"
bone_path <- file.path(base_path, "/intermediate/clustering")
bone_multi <- readRDS(file.path(bone_path, "bone_multi_postclustering.rds"))
plots_path <- paste0(base_path, "/grafici/espressione_tbx1/")
```

```{r setup_2, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
DefaultAssay(bone_multi) <- "RNA"
bone_multi <- JoinLayers(bone_multi, assay = "RNA")
DefaultLayer(bone_multi[["RNA"]]) <- "data"
Idents(bone_multi) <- "clusters_res_0_10"
```

## Visualizzazione dell’espressione di *Tbx1* nei diversi cluster.

```{r tbx1-cluster, echo=TRUE, message=FALSE, warning=FALSE, fig.width=10, fig.height=5}
p_vln_tbx1_cluster <- VlnPlot(bone_multi, features = "Tbx1", group.by = "clusters_res_0_10", pt.size = 0.4, layer = "data")
p_feat_tbx1 <-FeaturePlot(bone_multi, features = "Tbx1", reduction = "umap", order = TRUE)
p_umap_clusters  <- DimPlot(bone_multi, reduction = "umap", group.by = "clusters_res_0_10", label = TRUE, repel = TRUE)
p_insieme <- p_feat_tbx1 | p_umap_clusters
p_vln_tbx1_cluster
p_insieme
```

## Espressione media Tbx1

```{r average_expression, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE}
avg_tbx1 <- AverageExpression(
  bone_multi,
  features = "Tbx1",
  group.by = "clusters_res_0_10",
  layer = "data"
)
avg_tbx1_df <- as.data.frame(t(avg_tbx1$RNA))
avg_tbx1_df$cluster <- gsub("^g", "", rownames(avg_tbx1_df)) 
avg_tbx1_df <- avg_tbx1_df[order(-avg_tbx1_df$Tbx1), ]        
rownames(avg_tbx1_df) <- NULL                                 
print(avg_tbx1_df)
```

```{r fetch_data, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE}
df_tbx <- FetchData(bone_multi, vars = c("Tbx1", "clusters_res_0_10"))
summary_cluster <- df_tbx %>%
  group_by(clusters_res_0_10) %>%
  summarise(
    avg_Tbx1 = mean(Tbx1, na.rm = TRUE),
    pct_Tbx1_pos = mean(Tbx1 > 0, na.rm = TRUE)
  ) %>%
  arrange(desc(avg_Tbx1))

print(summary_cluster)
```

```{r plot, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE}
p_scatter_tbx1 <- ggplot(summary_cluster, aes(x = avg_Tbx1, y = pct_Tbx1_pos, label = clusters_res_0_10)) +
    geom_point(size = 3, color = "firebrick") +
    geom_text(vjust = -0.5, size = 3) +
    theme_minimal() +
    labs(x = "Media espressione Tbx1", y = "% cellule Tbx1+",
         title = "Espressione di Tbx1 nei cluster")
p_scatter_tbx1
```

## Visualizzazione dell’espressione di Tbx1 nei diversi cluster per genotipo

```{r tbx1-condition, echo=TRUE, message=FALSE, warning=FALSE, fig.width=10, fig.height=5}
bone_multi$condition <- factor(bone_multi$condition, levels = c("WT", "MUT"))
p_vln_tbx1_split <- VlnPlot(bone_multi, features = "Tbx1", group.by = "clusters_res_0_10", split.by = "condition",pt.size  = 0.4, layer = "data")

p_feat_tbx1_split <- FeaturePlot(bone_multi, features = "Tbx1", reduction = "umap", split.by = "condition", order = TRUE )

p_vln_tbx1_split
p_feat_tbx1_split
```

Al termine di questa analisi, i grafici relativi all’espressione di *Tbx1* sono stati salvati in formato *PNG* nella cartella dedicata e utilizzati per la descrizione dei risultati.

```{r salvataggio_plot, eval=TRUE, echo=TRUE}
ggsave(
  filename = file.path(plots_path, "VlnPlot_Tbx1_cluster.png"),
  plot = p_vln_tbx1_cluster,
  width = 10, height = 5, dpi = 300)

ggsave(
  filename = file.path(plots_path, "Tbx1_FeaturePlot_plus_UMAP_clusters.png"),
  plot = p_insieme,
  width = 12, height = 5, dpi = 300)

ggsave(
  filename = file.path(plots_path, "Scatter_avg_vs_pct_Tbx1.png"),
  plot = p_scatter_tbx1,
  width = 7, height = 5, dpi = 300)

ggsave(
  filename = file.path(plots_path, "VlnPlot_Tbx1_cluster_split_condition.png"),
  plot = p_vln_tbx1_split,
  width = 12, height = 6, dpi = 300)

ggsave(
  filename = file.path(plots_path, "FeaturePlot_Tbx1_split_condition.png"),
  plot = p_feat_tbx1_split,
  width = 12, height = 5, dpi = 300)

```


```{r session-info, echo=TRUE}
sessionInfo()
```