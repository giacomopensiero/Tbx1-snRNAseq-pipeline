---
title: 'Fase 4.4: Pathways Analisi'
author: "Giacomo Pensiero"
date: "2025-11-25"
output: html_document
---

In questo script viene eseguita la **pathways analysis**, che costituisce la *Fase 4* dell’analisi ed è dedicata all’interpretazione biologica dei risultati di *Differential Expression* ottenuti dopo il *clustering* (risoluzione *0.10*).  
I geni significativi vengono convertiti in *ENTREZ ID* e utilizzati per una **GO Biological Process over-representation analysis (ORA)** con *clusterProfiler* (correzione multipla *BH*), definendo come *background* l’insieme dei geni testati.  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libreria, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE}
library(clusterProfiler)
library(org.Mm.eg.db)
library(AnnotationDbi)
library(dplyr)
library(enrichplot)
library(ggplot2)
library(purrr)
library(patchwork)
library(forcats)
set.seed(1234)
```

```{r path, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
base_path <- "C:/Users/giaco/OneDrive/Desktop/TBX1/Analisi_Giacomo"
de_input_path <- file.path(base_path, "intermediate/DE")
risultati_path  <- file.path(base_path, "results/pathways")
grafici_path <- file.path(base_path, "grafici/pathways")
df_sign <- readRDS(file.path(de_input_path, "DE_all_classified_res0_10_significativi.rds"))
df_all  <- readRDS(file.path(de_input_path, "DE_All_res0_10.rds"))
```

```{r entrez-e-liste, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE}
clusters_target <- c(13, 18, 8)
sym2entrez <- AnnotationDbi::select(
  org.Mm.eg.db,
  keys = unique(df_all$gene),
  columns = c("SYMBOL","ENTREZID"),
  keytype = "SYMBOL"
) %>%
  dplyr::filter(!is.na(ENTREZID)) %>%
  dplyr::distinct(SYMBOL, ENTREZID)

df_all_entrez <- df_all %>%
  dplyr::inner_join(sym2entrez, by = c("gene" = "SYMBOL")) %>%
  dplyr::select(gene, ENTREZID, dplyr::everything())

universe_entrez <- unique(df_all_entrez$ENTREZID)

df_sign_entrez <- df_sign %>%
  dplyr::filter(cluster %in% clusters_target) %>%
  dplyr::inner_join(sym2entrez, by = c("gene" = "SYMBOL")) %>%
  dplyr::select(gene, ENTREZID, dplyr::everything())
df_sign_entrez %>%
  dplyr::count(cluster, direction)
tasks <- df_sign_entrez %>% distinct(cluster, direction)
gene_lists <- tasks %>%
  dplyr::mutate(
    genes = purrr::map2(cluster, direction, ~df_sign_entrez %>%
                          dplyr::filter(cluster == .x, direction == .y) %>%
                          dplyr::pull(ENTREZID) %>%
                          unique()),
    n_genes = purrr::map_int(genes, length))
gene_lists

```

```{r go, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE}
run_go <- function(genes, cl, dir_label) {
  genes <- unique(genes)
  if (length(genes) < 10) return(NULL)
  
  ego <- enrichGO(
    gene          = genes,
    universe      = universe_entrez,
    OrgDb         = org.Mm.eg.db,
    keyType       = "ENTREZID",
    ont           = "BP",
    pAdjustMethod = "BH",
    pvalueCutoff  = 0.05,
    qvalueCutoff  = 0.1,
    readable      = TRUE
  )
  
  df <- as.data.frame(ego)
  if (nrow(df) == 0) return(NULL)
  
  df$cluster <- cl
  df$direction <- dir_label
  df
}

ego_all <- gene_lists %>%
  dplyr::mutate(res = purrr::pmap(list(genes, cluster, direction), run_go)) %>%
  dplyr::pull(res) %>%
  purrr::compact() %>%
  dplyr::bind_rows()

ego_all %>% count(cluster, direction)
ego_all %>% select(cluster, direction, ID, Description, GeneRatio, p.adjust) %>% head(10)
```

```{r go-plot-cl8-up, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE}
cl  <- 8
dir <- "Up-regulated in MUT"

df_cl <- ego_all %>%
  dplyr::filter(cluster == cl, direction == dir) %>%
  dplyr::mutate(
    qscore = -log10(pmax(p.adjust, .Machine$double.xmin)),
    GeneRatio_num = vapply(
      strsplit(GeneRatio, "/"),
      function(x) as.numeric(x[1]) / as.numeric(x[2]),
      numeric(1)
    )
  ) %>%
  dplyr::arrange(desc(qscore)) %>%
  dplyr::slice_head(n = 15) %>%
  dplyr::mutate(Description = forcats::fct_reorder(Description, qscore))

p <- ggplot(df_cl, aes(x = qscore, y = Description, fill = GeneRatio_num)) +
  geom_col() +
  labs(
    title = paste0("GO BP – Cluster ", cl, " – ", dir),
    x = "-log10(adj p)",
    y = NULL,
    fill = "GeneRatio"
  ) +
  theme_minimal(base_size = 12)

print(p)
```

Vengono salvati i risultati completi della **GO BP ORA** (*GO_BP_ego_all*), all’interno della cartella `results/pathways`.

```{r save-go-results, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE}
saveRDS(ego_all, file = file.path(risultati_path, "GO_BP_ego_all.rds"))
write.csv(ego_all, file = file.path(risultati_path, "GO_BP_ego_all.csv"), row.names = FALSE)
ggsave(
  filename = file.path(grafici_path, "GO_BP_cluster8_up_top15.pdf"),
  plot = p, width = 9, height = 6
)
ggsave(
  filename = file.path(grafici_path, "GO_BP_cluster8_up_top15.png"),
  plot = p, width = 9, height = 6, dpi = 300
)
```

```{r session-info, echo=TRUE, eval=TRUE}
sessionInfo()
```


